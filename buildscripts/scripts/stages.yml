# Describes stages for test-gerrit Job

# some thoughts about this file:
# - stages should abort early if semantical condition is not met
# - stages should be sorted by probability to fail * duration
# - `make` is not needed at this level (but make-target could still call validate_changes.py)
# - running inside docker should be optional
# - some variables are not needed
#
# WARNING
#
# ENV_VAR_LIST and SEC_VAR_LIST shall not contain elements with "#", see test-gerrit.groovy
#

# yamllint disable rule:line-length

VARIABLES:
    - NAME: PATCHSET_REVISION
      # Will be used if not provided by Jenkins
      SH: "git rev-parse HEAD"

    - NAME: BASE_COMMIT_ID
      # Can be provided directly instead of PATCHSET_REVISION in order to compare HEAD against
      # arbitrary refs like `origin/master`
      SH: "git rev-parse ${PATCHSET_REVISION}^"

    - NAME: CHANGED_FILES_REL
      SH: "git diff-tree --no-commit-id --name-only -r ${BASE_COMMIT_ID}..HEAD | sort"

    - NAME: CHANGED_FILES_REL_WITHOUT_DELETED_FILES
      SH: "git --no-pager diff --name-only --diff-filter=d ${BASE_COMMIT_ID}..HEAD | sort"

    - NAME: CHANGED_FILES_WITH_MODE
      SH: "git diff-tree --no-commit-id --name-status -r ${BASE_COMMIT_ID}..HEAD | sort"

    - NAME: CHANGED_MAKEFILE
      SH: "echo '${CHANGED_FILES_REL}' | grep '^Makefile' || true"

    - NAME: CHANGED_REFERENCE_IMAGE
      SH: "echo '${CHANGED_FILES_REL}' | grep '^defines/dev-images/reference/Dockerfile' || true"

    - NAME: CHANGED_TESTS_MAKEFILE
      SH: "echo '${CHANGED_FILES_REL}' | grep '^tests/Makefile' || true"

    - NAME: CHANGED_PYTHON_FILES
      SH: "git diff-tree --no-commit-id --name-only -r ${BASE_COMMIT_ID}..HEAD | xargs realpath | ${WORKSPACE}/scripts/find-python-files --filter"

    - NAME: CHANGED_SHELL_FILES
      SH: "git diff-tree --no-commit-id --name-only -r ${BASE_COMMIT_ID}..HEAD | xargs realpath | ${WORKSPACE}/scripts/find-shell-files --filter"

    - NAME: CHANGED_GROOVY_LINT_RC
      SH: "echo '${CHANGED_FILES_REL}' | grep '.groovylintrc.json$' || true"

    - NAME: CHANGED_PYPROJECT_TOML_FILE
      SH: "echo '${CHANGED_FILES_REL}' | grep '^pyproject.toml' || true"

    - NAME: CHANGED_PYTHON_REQUIREMENTS
      SH: "echo '${CHANGED_FILES_REL}' | grep 'requirements.txt\\|requirements.in\\|constraints.txt' || true"

    - NAME: CHANGED_BAZEL_MODULES
      SH: "echo '${CHANGED_FILES_REL}' | grep '^MODULE.bazel' || true"

    - NAME: CHANGED_FIND_PYTHON_FILES_SCRIPT
      SH: "echo '${CHANGED_FILES_REL}' | grep '^scripts/find-python-files' || true"

    - NAME: CHANGED_RUN_UVENV_SCRIPT
      SH: "echo '${CHANGED_FILES_REL}' | grep '^scripts/run-uvenv' || true"

    - NAME: CHANGED_BAZEL_FILES
      SH: "echo '${CHANGED_FILES_REL}' | grep '\\.bzl$\\|BUILD\\|WORKSPACE' || true"

    - NAME: CHANGED_AGENT_PLUGINS
      SH: "echo '${CHANGED_FILES_REL}' | grep '^agents/plugins/' || true"
      REPLACE_NEWLINES: true

    - NAME: CHANGED_AGENT_PLUGINS_TESTS
      SH: "echo '${CHANGED_FILES_REL}' | grep '^tests/agent-plugin-unit/' || true"
      REPLACE_NEWLINES: true

    - NAME: CHANGED_SW_DOC_FILES
      SH: "echo '${CHANGED_FILES_REL}' | grep 'doc/documentation/' || true"
      REPLACE_NEWLINES: true

    - NAME: CHANGED_WERK_FILES
      SH: "echo '${CHANGED_FILES_REL}' | grep '^\\.werks/' || true"
      REPLACE_NEWLINES: true

    - NAME: CHANGED_WERK_FILES_WITHOUT_DELETED_WERKS
      SH: "echo '${CHANGED_FILES_REL_WITHOUT_DELETED_FILES}' | grep '^\\.werks/' || true"
      REPLACE_NEWLINES: true

    - NAME: CHANGED_WERK_CODE_FILES
      SH: "echo '${CHANGED_FILES_REL}' | grep '^packages/cmk-werks\\|^cmk/utils/werks' || true"
      REPLACE_NEWLINES: true

    - NAME: CHANGED_JS_DEPENDENCIES
      SH: "echo '${CHANGED_FILES_REL}' | grep '^package.json\\|^pnpm-' || true"

    - NAME: CHANGED_CMK_PLUGINS
      SH: "echo '${CHANGED_FILES_REL}' | grep 'cmk/plugins/' || true"
      REPLACE_NEWLINES: true

    - NAME: CHANGED_CMK_CHECKENGINE
      SH: "echo '${CHANGED_FILES_REL}' | grep '^cmk/checkengine/' || true"
      REPLACE_NEWLINES: true

    - NAME: CHANGED_CMK_DISCOVER_PLUGINS
      SH: "echo '${CHANGED_FILES_REL}' | grep '^cmk/discover_plugins/' || true"
      REPLACE_NEWLINES: true

    - NAME: CHANGED_CMK_GUI
      SH: "echo '${CHANGED_FILES_REL}' | grep '^cmk/gui/' || true"
      REPLACE_NEWLINES: true

    - NAME: CHANGED_CMK_SERVER_SIDE_CALLS_BACKEND
      SH: "echo '${CHANGED_FILES_REL}' | grep '^cmk/server_side_calls_backend/' || true"
      REPLACE_NEWLINES: true

    - NAME: CHANGED_CMK_UTILS
      SH: "echo '${CHANGED_FILES_REL}' | grep '^cmk/utils/' || true"
      REPLACE_NEWLINES: true

    - NAME: CHANGED_CMK_BASE_CONFIG
      SH: "echo '${CHANGED_FILES_REL}' | grep '^cmk/base/config' || true"
      REPLACE_NEWLINES: true

    ########## packages ########################################################

    - NAME: CHANGED_MK_ORACLE_FILES
      SH: "echo '${CHANGED_FILES_REL}' | grep '^packages/mk-oracle/\\|^requirements/rust/host' || true"

    - NAME: CHANGED_CMK_AGENT_RECEIVER_FILES
      SH: "echo '${CHANGED_FILES_REL}' | grep '^packages/cmk-agent-receiver/' || true"

    - NAME: CHANGED_CMK_CCC_FILES
      SH: "echo '${CHANGED_FILES_REL}' | grep '^packages/cmk-ccc/' || true"

    - NAME: CHANGED_CMK_EC_FILES
      SH: "echo '${CHANGED_FILES_REL}' | grep '^packages/cmk-ec/' || true"

    - NAME: CHANGED_OTEL_FILES
      SH: "echo '${CHANGED_FILES_REL}' | grep '^non-free/packages/otel-collector/' || true"

    - NAME: CHANGED_GO_MOD
      SH: "echo '${CHANGED_FILES_REL}' | grep '^go.mod' || true"

    - NAME: CHANGED_CMK_RELAY_PROTOCOLS_FILES
      SH: "echo '${CHANGED_FILES_REL}' | grep '^packages/cmk-relay-protocols/' || true"

    - NAME: CHANGED_CMK_WERKS_FILES
      SH: "echo '${CHANGED_FILES_REL}' | grep '^packages/cmk-werks/' || true"

    - NAME: CHANGED_CMK_TRACE_FILES
      SH: "echo '${CHANGED_FILES_REL}' | grep '^packages/cmk-trace/' || true"

    - NAME: CHANGED_CMK_UPDATE_AGENT_FILES
      SH: "echo '${CHANGED_FILES_REL}' | grep '^non-free/packages/cmk-update-agent/' || true"

    - NAME: CHANGED_FRONTEND_VUE_FILES
      SH: "echo '${CHANGED_FILES_REL}' | grep '^packages/cmk-frontend-vue/' || true"

    - NAME: CHANGED_SHARED_TYPING_FILES
      SH: "echo '${CHANGED_FILES_REL}' | grep '^packages/cmk-shared-typing/' || true"

    - NAME: CHANGED_RELAY_ENGINE_FILES
      SH: "echo '${CHANGED_FILES_REL}' | grep '^non-free/packages/cmk-relay-engine/' || true"

STAGES:
    - NAME: "Bazel sanity check (guarded)"
      ONLY_WHEN_NOT_EMPTY: CHANGED_BAZEL_FILES
      COMMAND: |
          bazel aquery ... &> ${RESULTS}/results.txt && rm ${RESULTS}/results.txt || exit 1
          bazel cquery ... &> ${RESULTS}/results.txt && rm ${RESULTS}/results.txt || exit 1
          bazel mod graph --output=json | jq -e ".. | select(.name? == \"boringssl\")" >"${RESULTS}/results.txt" && exit 1 || true
      RESULT_CHECK_FILE_PATTERN: "results/results.txt"
      BAZEL_LOCKS_AMOUNT: 1

    - NAME: "Bazel sanity check"
      COMMAND: |
          ./scripts/in_bazel.sh "py" "py_binary|py_library|py_test" 28 > ${RESULTS}/results.txt
      RESULT_CHECK_FILE_PATTERN: "results/results.txt"
      BAZEL_LOCKS_AMOUNT: 1

    - NAME: "All unit tests"
      SEC_VAR_LIST:
        - "CI_TEST_SQL_DB_ENDPOINT"
      ENV_VARS:
        BAZEL_TEST_LOGS_DEST: "../results/unit"
      DIR: "tests"
      COMMAND: |
          set +e
          bazel test \
              --jobs=4 \
              --local_resources=cpu=4 \
              --test_verbose_timeout_warnings \
              --test_env=TZ="America/Chicago" \
              --test_tag_filters=-component \
              --keep_going \
              --//:use_faked_artifacts=true \
              -- //... \
              -//packages/livestatus/... \
              -//packages/neb/... \
              -//packages/unixcat/... \
              -//non-free/packages/cmc/...
          make_rc=$?
          set -e
          ../buildscripts/scripts/bazel_test_post_archive_xunit.sh || :
          exit $make_rc
      BAZEL_LOCKS_AMOUNT: 1
      RESULT_CHECK_TYPE: "JUNIT"
      RESULT_CHECK_FILE_PATTERN: "results/unit/**/test.xml"
      JENKINS_TEST_RESULT_PATH: "testReport/"

    - NAME: "C++ unit tests"
      DIR: "tests"
      ENV_VARS:
        BAZEL_TEST_LOGS_DEST: "../results/cpp"
      COMMAND: |
        set +e
        bazel test \
            --jobs=4 \
            --local_resources=cpu=4 \
            --test_verbose_timeout_warnings \
            --test_env=TZ="America/Chicago" \
            --test_tag_filters=cpp \
            --keep_going \
            --//:use_faked_artifacts=True \
            --run_under="$(which valgrind) --quiet --num-callers=30 --error-exitcode=42" \
            -- //...
        make_rc=$?
        set -e
        ../buildscripts/scripts/bazel_test_post_archive_xunit.sh || :
        exit $make_rc
      BAZEL_LOCKS_AMOUNT: 1
      RESULT_CHECK_TYPE: "GoogleTest"
      RESULT_CHECK_FILE_PATTERN: "results/cpp/**/test.xml"
      JENKINS_TEST_RESULT_PATH: "testReport/(root)/"

    - NAME: "Python License Headers Test"
      ONLY_WHEN_NOT_EMPTY: CHANGED_REFERENCE_IMAGE,CHANGED_FIND_PYTHON_FILES_SCRIPT,CHANGED_PYTHON_FILES
      DIR: "tests"
      ENV_VARS:
          PYTEST_ADDOPTS: "--junitxml=${RESULTS}/python3-license-headers-junit.xml --color=no"
      COMMAND: "make test-license-headers"
      BAZEL_LOCKS_AMOUNT: 1
      TEXT_ON_SKIP: "No Python files changed"
      RESULT_CHECK_TYPE: "JUNIT"
      RESULT_CHECK_FILE_PATTERN: "results/python3-license-headers-junit.xml"
      JENKINS_TEST_RESULT_PATH: "testReport/pytest.tests.code_quality/test_license_headers/"

    - NAME: "Python Requirements Test"
      ONLY_WHEN_NOT_EMPTY: CHANGED_REFERENCE_IMAGE,CHANGED_PYTHON_REQUIREMENTS,CHANGED_FIND_PYTHON_FILES_SCRIPT,CHANGED_PYTHON_FILES,CHANGED_RELAY_ENGINE_FILES
      DIR: "tests"
      ENV_VARS:
          PYTEST_ADDOPTS: "--junitxml=${RESULTS}/python3-requirements-junit.xml --color=no"
      COMMAND: "make test-requirements"
      BAZEL_LOCKS_AMOUNT: 1
      TEXT_ON_SKIP: "Requirements files not changed"
      RESULT_CHECK_TYPE: "JUNIT"
      RESULT_CHECK_FILE_PATTERN: "results/python3-requirements-junit.xml"
      JENKINS_TEST_RESULT_PATH: "testReport/pytest.tests.code_quality/test_requirements/"

    - NAME: "Python only Py-Extensions"
      ONLY_WHEN_NOT_EMPTY: CHANGED_REFERENCE_IMAGE,CHANGED_FIND_PYTHON_FILES_SCRIPT,CHANGED_PYTHON_FILES
      DIR: "tests"
      ENV_VARS:
          PYTEST_ADDOPTS: "--color=no"
      # CHANGED_FILES_WITH_MODE can be huge, so we use a file to transport the list
      # also we need to explicitly handover the path variable to make test-py-extensions
      COMMAND: |
          CHANGED_FILES_WITH_MODE_FILE=$(mktemp)
          echo "${CHANGED_FILES_WITH_MODE}" > $CHANGED_FILES_WITH_MODE_FILE
          trap "rm -f $CHANGED_FILES_WITH_MODE_FILE" EXIT
          CHANGED_FILES_WITH_MODE_FILE=$CHANGED_FILES_WITH_MODE_FILE RESULTS_FILE=${RESULTS}/python-extensions.txt make test-py-extensions
      BAZEL_LOCKS_AMOUNT: 1
      RESULT_CHECK_TYPE: "JUNIT"
      RESULT_CHECK_FILE_PATTERN: "results/python-extensions.txt"
      JENKINS_TEST_RESULT_PATH: "testReport/pytest.tests.code_quality/test_py_extensions/"

    - NAME: "Python File Content Test"
      ONLY_WHEN_NOT_EMPTY: CHANGED_REFERENCE_IMAGE,CHANGED_FIND_PYTHON_FILES_SCRIPT,CHANGED_PYTHON_FILES
      DIR: "tests"
      ENV_VARS:
          PYTEST_ADDOPTS: "--junitxml=${RESULTS}/python3-file-content-junit.xml --color=no"
      COMMAND: "make test-file-content"
      TEXT_ON_SKIP: "No files changed"
      BAZEL_LOCKS_AMOUNT: 1
      RESULT_CHECK_TYPE: "JUNIT"
      RESULT_CHECK_FILE_PATTERN: "results/python3-file-content-junit.xml"
      JENKINS_TEST_RESULT_PATH: "testReport/pytest.tests.code_quality.file_content/"

    - NAME: "Python Werks Test"
      ONLY_WHEN_NOT_EMPTY: CHANGED_REFERENCE_IMAGE,CHANGED_WERK_FILES
      DIR: "tests"
      GIT_FETCH_TAGS: true
      ENV_VARS:
          PYTEST_ADDOPTS: "--junitxml=${RESULTS}/python3-werks-junit.xml --color=no"
      COMMAND: "make test-werks"
      BAZEL_LOCKS_AMOUNT: 1
      TEXT_ON_SKIP: "No Werk files changed"
      RESULT_CHECK_TYPE: "JUNIT"
      RESULT_CHECK_FILE_PATTERN: "results/python3-werks-junit.xml"
      JENKINS_TEST_RESULT_PATH: "testReport/pytest.tests.code_quality/test_werks/"

    - NAME: "Python Werks validate"
      ONLY_WHEN_NOT_EMPTY: CHANGED_REFERENCE_IMAGE,CHANGED_WERK_FILES_WITHOUT_DELETED_WERKS,CHANGED_RUN_UVENV_SCRIPT
      ENV_VARS:
          CHANGED_WERK_FILES: "${CHANGED_WERK_FILES_WITHOUT_DELETED_WERKS}"
      COMMAND: "./scripts/run-uvenv python -m cmk.werks.validate &> ${RESULTS}/werk_validate.txt"
      BAZEL_LOCKS_AMOUNT: 1
      TEXT_ON_SKIP: "No Werk files changed"
      RESULT_CHECK_FILE_PATTERN: "results/werk_validate.txt"

    - NAME: "Python Werks Commands"
      ONLY_WHEN_NOT_EMPTY: CHANGED_REFERENCE_IMAGE,CHANGED_WERK_CODE_FILES,CHANGED_RUN_UVENV_SCRIPT
      GIT_FETCH_NOTES: true
      BAZEL_LOCKS_AMOUNT: 1
      COMMAND: |
          scripts/run-uvenv python3 -m cmk.werks.utils collect cmk . --substitute-branches $(git symbolic-ref --short HEAD):HEAD &> ${RESULTS}/werk_commands.txt
          scripts/run-uvenv python3 -m cmk.utils.werks announce .werks $(make print-VERSION) --format md &>> ${RESULTS}/werk_commands.txt
          scripts/run-uvenv python3 -m cmk.utils.werks announce .werks $(make print-VERSION) --format txt &>> ${RESULTS}/werk_commands.txt
          scripts/run-uvenv python3 -m cmk.werks.utils precompile .werks precompiled.json &>> ${RESULTS}/werk_commands.txt
          scripts/run-uvenv python3 -m cmk.werks.utils changelog CHANGELOG precompiled.json &>> ${RESULTS}/werk_commands.txt
          scripts/run-uvenv python3 -m cmk.utils.werks mail . HEAD werk_mail --assume-no-notes-but=$(git log --before="$(date --date="4 weeks ago" --iso=seconds)" --format="%H" --max-count=1) &>> ${RESULTS}/werk_commands.txt
          scripts/run-uvenv werk list &>> ${RESULTS}/werk_commands.txt
      TEXT_ON_SKIP: "No Werk code files changed"
      RESULT_CHECK_FILE_PATTERN: "results/werk_commands.txt"

    - NAME: "Shell Unit Tests"
      ONLY_WHEN_NOT_EMPTY: CHANGED_REFERENCE_IMAGE,CHANGED_SHELL_FILES
      DIR: "tests"
      COMMAND: "make test-unit-shell &> ${RESULTS}/shell-unit.txt"
      BAZEL_LOCKS_AMOUNT: 1
      TEXT_ON_SKIP: "No Shell files changed"
      RESULT_CHECK_TYPE: "SHELLUNIT"
      RESULT_CHECK_FILE_PATTERN: "results/shell-unit.txt"

    - NAME: "Bazel Lint"
      ONLY_WHEN_NOT_EMPTY: CHANGED_REFERENCE_IMAGE,CHANGED_BAZEL_FILES
      COMMAND: "bazel run //:buildifier.check 2>${RESULTS}/bazel-lint.txt"
      BAZEL_LOCKS_AMOUNT: 1
      TEXT_ON_SKIP: "No Bazel files changed"
      RESULT_CHECK_TYPE: "BAZELLINT"
      RESULT_CHECK_FILE_PATTERN: "results/bazel-lint.txt"

    - NAME: "Agent Plugin Unit Tests"
      ONLY_WHEN_NOT_EMPTY: CHANGED_REFERENCE_IMAGE,CHANGED_AGENT_PLUGINS,CHANGED_AGENT_PLUGINS_TESTS,CHANGED_TESTS_MAKEFILE
      DIR: "tests"
      COMMAND: "make test-agent-plugin > ${RESULTS}/agent-plugin-unit-junit.txt"
      TEXT_ON_SKIP: "No agent files changed"
      BAZEL_LOCKS_AMOUNT: 1
      RESULT_CHECK_FILE_PATTERN: "results/agent-plugin-unit-junit.txt"

    - NAME: "Software Documentation Generation"
      ONLY_WHEN_NOT_EMPTY: CHANGED_REFERENCE_IMAGE,CHANGED_SW_DOC_FILES,CHANGED_MAKEFILE
      COMMAND: "make sw-documentation &> ${RESULTS}/sw-documentation.txt"
      TEXT_ON_SKIP: "No SW Documentation files changed"
      BAZEL_LOCKS_AMOUNT: 1
      RESULT_CHECK_FILE_PATTERN: "results/sw-documentation.txt"

    - NAME: "Detect Merge Conflicts"
      COMMAND: "./scripts/check-merge-conflicts ${PATCHSET_REVISION} &> ${RESULTS}/merge-conflicts.txt"
      RESULT_CHECK_FILE_PATTERN: "results/merge-conflicts.txt"

    - NAME: "Plugins Consistency"
      ONLY_WHEN_NOT_EMPTY: CHANGED_CMK_PLUGINS,CHANGED_CMK_CHECKENGINE,CHANGED_CMK_DISCOVER_PLUGINS,CHANGED_CMK_GUI,CHANGED_CMK_SERVER_SIDE_CALLS_BACKEND,CHANGED_CMK_UTILS,CHANGED_CMK_BASE_CONFIG
      DIR: "tests"
      COMMAND: "make test-plugins-consistency"
      BAZEL_LOCKS_AMOUNT: 1
      TEXT_ON_SKIP: "No cmk-plugins files changed"
      RESULT_CHECK_FILE_PATTERN: "results/plugins-consistency.html"

    ########## packages ########################################################

    - NAME: "Package cmk-agent-receiver"
      ONLY_WHEN_NOT_EMPTY: CHANGED_REFERENCE_IMAGE,CHANGED_PYPROJECT_TOML_FILE,CHANGED_CMK_AGENT_RECEIVER_FILES,CHANGED_PYTHON_REQUIREMENTS,CHANGED_CMK_RELAY_PROTOCOLS_FILES
      DIR: "packages/cmk-agent-receiver"
      COMMAND: "./run --component-tests --testlib-tests &> ${RESULTS}/cmk-agent-receiver.txt"
      BAZEL_LOCKS_AMOUNT: 1
      TEXT_ON_SKIP: "No cmk-agent-receiver files changed"
      RESULT_CHECK_FILE_PATTERN: "results/cmk-agent-receiver.txt"

    - NAME: "Package otel-collector"
      ONLY_WHEN_NOT_EMPTY: CHANGED_OTEL_FILES, CHANGED_GO_MOD
      DIR: "non-free/packages/otel-collector"
      # No entry point for linters
      COMMAND: "./run --check-format  &> ${RESULTS}/otel-collector.txt"
      BAZEL_LOCKS_AMOUNT: 1
      TEXT_ON_SKIP: "No otel-collector files changed"
      RESULT_CHECK_FILE_PATTERN: "results/otel-collector.txt"

    - NAME: "Package cmk-frontend-vue"
      ONLY_WHEN_NOT_EMPTY: CHANGED_REFERENCE_IMAGE,CHANGED_FRONTEND_VUE_FILES,CHANGED_SHARED_TYPING_FILES,CHANGED_JS_DEPENDENCIES
      DIR: "packages/cmk-frontend-vue"
      COMMAND: "./run -B --build-dev --lint &> ${RESULTS}/cmk-frontend-vue.txt"
      BAZEL_LOCKS_AMOUNT: 1
      TEXT_ON_SKIP: "No cmk-frontend-vue files changed"
      RESULT_CHECK_FILE_PATTERN: "results/cmk-frontend-vue.txt"

    - NAME: "Package mk-oracle"
      ONLY_WHEN_NOT_EMPTY: CHANGED_REFERENCE_IMAGE,CHANGED_MK_ORACLE_FILES
      SEC_VAR_LIST:
          - "CI_TEST_SQL_DB_ENDPOINT"
          - "CI_ORA2_DB_TEST_PASSWORD"
      DIR: "packages/mk-oracle"
      COMMAND: "./run --component-tests"
      BAZEL_LOCKS_AMOUNT: 1
      TEXT_ON_SKIP: "No mk-oracle files changed"
      RESULT_CHECK_FILE_PATTERN: "mk-oracle.txt"

    - NAME: "Package cmk-relay-engine"
      ONLY_WHEN_NOT_EMPTY: CHANGED_REFERENCE_IMAGE,CHANGED_PYPROJECT_TOML_FILE,CHANGED_RELAY_ENGINE_FILES,CHANGED_PYTHON_REQUIREMENTS,CHANGED_CMK_RELAY_PROTOCOLS_FILES
      DIR: "non-free/packages/cmk-relay-engine"
      COMMAND: "./run --component-tests"
      BAZEL_LOCKS_AMOUNT: 1
      TEXT_ON_SKIP: "No cmk-relay-engine files changed"
      RESULT_CHECK_FILE_PATTERN: "cmk-relay-engine.txt"

    - NAME: "Format repository"
      COMMAND: "bazel run //:format.check &> ${RESULTS}/format.txt"
      BAZEL_LOCKS_AMOUNT: 1
      TEXT_ON_SKIP: "inconditional"
      RESULT_CHECK_FILE_PATTERN: "results/format.txt"

    - NAME: "Lint repository"
      COMMAND: |
          set +e
          bazel lint --machine --fixes=false ... &> ${RESULTS}/lint.txt
          exit_code=$?
          set -e
          bazel run //scripts:sarif_preparse -- --root_dir=$PWD/bazel-bin --output ${RESULTS}/results.sarif || true
          exit $exit_code
      TEXT_ON_SKIP: "inconditional"
      BAZEL_LOCKS_AMOUNT: 1
      RESULT_CHECK_TYPE: "SARIF"
      RESULT_CHECK_FILE_PATTERN: "results/results.sarif"

    - NAME: "semgrep repository"
      COMMAND: |
          bazel run --run_under="cd $PWD &&" //bazel/tools:semgrep -- \
              scan \
              --config=.semgrep/rules \
              --oss-only \
              --disable-version-check \
              --junit-xml-output=results/semgrep.xml
      TEXT_ON_SKIP: "inconditional"
      BAZEL_LOCKS_AMOUNT: 1
      # Note that --sarif-output=VAL is unusable
      # https://github.com/semgrep/semgrep/issues/6658
      RESULT_CHECK_TYPE: "JUNIT"
      RESULT_CHECK_FILE_PATTERN: "results/semgrep.xml"

    - NAME: "Type repository with mypy"
      COMMAND: |
          set +e
          bazel \
             build \
             --jobs=4 \
             --local_resources=cpu=4 \
             --keep_going \
             --aspects=//bazel/tools:aspects.bzl%mypy_aspect \
             --output_groups=mypy \
             ...
          exit_code=$?
          set -e
          bazel \
             --run_under="cd $PWD &&" \
             run \
             //scripts:collect_mypy \
             -- \
             bazel-out/k8-fastbuild/bin \
             > results/mypy-results.xml
          exit $exit_code
      BAZEL_LOCKS_AMOUNT: 1
      TEXT_ON_SKIP: "inconditional"
      RESULT_CHECK_TYPE: "JUNIT"
      RESULT_CHECK_FILE_PATTERN: "results/mypy-results.xml"

    - NAME: "Enforced package build"
      ONLY_WHEN_NOT_EMPTY: CHANGED_PYTHON_REQUIREMENTS,CHANGED_BAZEL_MODULES,CHANGED_BAZEL_FILES,CHANGED_MAKEFILE
      COMMAND: "scripts/run-uvenv ci-artifacts --credentials url_env=JENKINS_URL,username_env=JENKINS_USERNAME,password_env=JENKINS_PASSWORD --log-level info validate checkmk/master/builders/trigger-cmk-distro-package --params=DISTRO=ubuntu-24.04,VERSION=daily,EDITION=enterprise,CUSTOM_GIT_REF=${PATCHSET_REVISION}"
      TEXT_ON_SKIP: "No package dependencies changed"

    - NAME: "Enforced relay build"
      ONLY_WHEN_NOT_EMPTY: CHANGED_PYTHON_REQUIREMENTS,CHANGED_BAZEL_MODULES,CHANGED_BAZEL_FILES,CHANGED_MAKEFILE
      COMMAND: "bazel build --cmk_edition=ultimate --cmk_version=$(make print-VERSION) //omd/non-free/relay:image_tar &> ${RESULTS}/cmk-relay-build.txt"
      TEXT_ON_SKIP: "No package dependencies changed"
      RESULT_CHECK_FILE_PATTERN: "results/cmk-relay-build.txt"
